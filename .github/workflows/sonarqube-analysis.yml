name: Conditional SonarQube Analysis on Push

on:
  push:
    branches:
      - main  # Only trigger on push to the main branch
    paths:
      - 'main/**'  # Trigger job for changes in the 'main' directory
      - 'feature1/**'  # Trigger job for changes in the 'feature' directory

jobs:
  sonarQubeInstance1:
    name: SonarQube Scan for Main Instance
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'main') || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up Java (SonarQube requires Java 11)
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Run SonarQube Scan for Main Instance
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN_MAIN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL_MAIN }}
        with:
          args: >
            -Dsonar.projectKey=terraform_main
            -Dsonar.sources=main/
            -Dsonar.language=java
            -X
